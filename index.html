<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PELIKELLO</title>
  <style>
    :root{
      --fg:#f5f7fb; --muted:#c7d0df; --accent:#7CFFA5; --accent2:#2CE88D; --danger:#ff4d4d;
      --panel:rgba(8,12,18,.58); --panelBorder:rgba(255,255,255,.14);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--fg); font:600 16px/1.4 system-ui, Segoe UI, Roboto, Helvetica, Arial;
      display:grid; place-items:center; min-height:100svh;
    }
    /* Tausta: näytä HPS-kuva selkeämmin kehyksen ulkopuolella */
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('hps.jpg') center/cover no-repeat; filter:saturate(1.1) contrast(1.05);}  
    body::after{content:""; position:fixed; inset:0; z-index:-1; background:
      radial-gradient(70% 70% at 50% 20%, rgba(0,0,0,.25), rgba(0,0,0,.60)),
      linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.40));
      backdrop-filter: blur(1px);
    }

    .wrap{width:min(980px,94vw); padding:18px}

    /* Tuplakello-suoja: jos DOMiin lipsahtaa useampi kortti, näytä vain ensimmäinen */
    .wrap .card:not(:first-of-type){display:none !important}

    .card{background:var(--panel); border:1px solid var(--panelBorder); border-radius:24px; box-shadow:0 20px 60px rgba(0,0,0,.45); padding:18px}

    .topbar{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    h1{margin:0; font-size:clamp(18px,4vw,22px); letter-spacing:.02em}
    .phase{font-size:clamp(12px,3.2vw,14px); color:var(--muted); text-transform:uppercase; letter-spacing:.12em}

    .timer{display:grid; place-items:center; margin:6px 0 12px}
    .big{font-variant-numeric:tabular-nums; font-size:clamp(48px,16vw,120px); line-height:1; letter-spacing:.02em; text-shadow:0 0 32px rgba(44,232,141,.20), 0 2px 0 rgba(0,0,0,.5)}
    .extra{font-variant-numeric:tabular-nums; font-size:clamp(18px,6vw,28px); margin-top:6px}
    .extra.positive{color:var(--accent)}
    .extra.negative{color:var(--danger)}

    .hud{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin:10px 0 14px}

    .pill{display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--panelBorder); border-radius:999px; background:rgba(255,255,255,.04)}
    .pill label{font-size:14px; color:var(--muted)}
    select{appearance:none; background:rgba(255,255,255,.9); border:1px solid var(--panelBorder); color:#000; border-radius:12px; padding:10px 12px; font-weight:700}
    select:disabled{opacity:.6}

    .controls{display:flex; flex-wrap:wrap; gap:10px; justify-content:center}
    button{appearance:none; border-radius:16px; border:1px solid transparent; font:800 16px/1 system-ui; padding:14px 18px; cursor:pointer; user-select:none; box-shadow:0 10px 30px rgba(0,0,0,.35);}
    .primary{background:linear-gradient(180deg, var(--accent), var(--accent2)); color:#052d18}
    .ghost{background:rgba(255,255,255,.06); border-color:var(--panelBorder); color:var(--fg)}
    .danger{background:linear-gradient(180deg, #ff9090, #ff6b6b); color:#2a0000}

    .miniNote{margin-top:6px; text-align:center; color:var(--muted); font-size:13px}
    .badge{display:inline-flex; gap:8px; align-items:center; padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--panelBorder); color:var(--muted); font-size:13px}

    .split{height:1px; background:linear-gradient(90deg, transparent, rgba(255,255,255,.2), transparent); margin:14px 0}

    .summaryArea{display:grid; gap:10px; margin-top:8px}
    .sumRow{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:14px; background:rgba(255,255,255,.04); border:1px solid var(--panelBorder)}
    .sumRow .lbl{color:var(--muted)}
    .sumRow .val{font-variant-numeric:tabular-nums; font-weight:800}
    .sumRow .stp{font-variant-numeric:tabular-nums; font-weight:800}
    .sumRow .stp.pos{color:var(--accent)}
    .sumRow .stp.neg{color:var(--danger)}

    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="app">
      <div class="topbar">
        <h1>PELIKELLO</h1>
        <div class="phase" id="phase">Valmis – Ennen ottelua</div>
      </div>

      <div class="timer" aria-live="polite">
        <div class="big" id="regClock">00:00</div>
        <div class="extra hidden" id="stoppageClock">+0:00</div>
        <div class="miniNote hidden" id="h1Badge"></div>
      </div>

      <div class="hud">
        <div class="pill">
          <label for="len">Otteluaika</label>
          <select id="len">
            <option value="1800">2 × 30'</option>
            <option value="2100">2 × 35'</option>
            <option value="2400">2 × 40'</option>
            <option value="2700" selected>2 × 45'</option>
            <option value="10">TEST 2 × 10s</option>
          </select>
        </div>
        <span class="badge" id="statusBadge">⏳ Odottaa käynnistystä</span>
      </div>

      <div class="controls" id="controls">
        <button class="primary" id="btnStart">Käynnistä ottelu</button>
        <button class="ghost hidden" id="btnHalftime">Erätauko</button>
        <button class="primary hidden" id="btnStartH2">Käynnistä 2. puoliaika</button>
        <button class="danger hidden" id="btnEnd">Lopeta</button>
        <button class="ghost hidden" id="btnReset">Nollaa</button>
        <button class="danger hidden" id="btnStopEarly">Keskeytä erä</button>
        <button class="primary hidden" id="btnResume">Jatka peliä</button>
      </div>

      <div class="split"></div>

      <div class="summaryArea" id="summary"></div>
    </div>
  </div>

  <audio id="beep" preload="auto">
    <source src="data:audio/wav;base64,UklGRhYAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAZGF0YQAAAAAA" type="audio/wav" />
  </audio>

<script>
(()=>{
  const S = { PRE:'PRE', H1_REG:'H1_REG', H1_STP:'H1_STP', H1_EARLY:'H1_EARLY', HT:'HT', H2_REG:'H2_REG', H2_STP:'H2_STP', H2_EARLY:'H2_EARLY', FT:'FT' };
  let state = S.PRE;

  const el = {
    len: document.getElementById('len'),
    phase: document.getElementById('phase'),
    regClock: document.getElementById('regClock'),
    stoppageClock: document.getElementById('stoppageClock'),
    h1Badge: document.getElementById('h1Badge'),
    statusBadge: document.getElementById('statusBadge'),
    btnStart: document.getElementById('btnStart'),
    btnHalftime: document.getElementById('btnHalftime'),
    btnStartH2: document.getElementById('btnStartH2'),
    btnEnd: document.getElementById('btnEnd'),
    btnReset: document.getElementById('btnReset'),
    btnStopEarly: document.getElementById('btnStopEarly'),
    btnResume: document.getElementById('btnResume'),
    summary: document.getElementById('summary'),
    beep: document.getElementById('beep'),
  };

  let perHalf = 2700;   // s
  let regStart = 0;     // ms
  let stpStart = 0;     // ms

  // Yhteenvetoa varten
  let h1Stoppage = 0;   // s, voi olla negatiivinen (keskeytys)
  let h2Stoppage = 0;   // s, voi olla negatiivinen (keskeytys)
  let h1RegDisp = 0;    // s, näytettävä peliaika (perHalf tai pausedAt)
  let h2RegDisp = 0;    // s

  // Keskeytyshetki
  let pausedAt = 0;     // s, kulunut peliaika keskeytyshetkellä
  let earlyOffset = 0;  // s, kuinka paljon jäi pelaamatta

  function fmt2(n){ return String(n).padStart(2,'0'); }
  function fmtMS(sec){ sec = Math.max(0, Math.floor(sec)); const m = Math.floor(sec/60), s = sec%60; return `${fmt2(m)}:${fmt2(s)}`; }
  function fmtPlus(sec){ sec = Math.max(0, Math.floor(sec)); const m = Math.floor(sec/60), s = sec%60; return `+${m}:${fmt2(s)}`; }
  function fmtSigned(sec){ const sign = sec>=0?'+':'-'; sec = Math.abs(Math.floor(sec)); const m=Math.floor(sec/60), s=sec%60; return `${sign}${m}:${fmt2(s)}`; }
  function playBeep(){ try{ el.beep.currentTime=0; el.beep.play(); }catch(_){}} 

  function setState(next){ state = next; updateUI(); }
  function lockLen(lock){ el.len.disabled = !!lock; }

  function startH1(){ perHalf=parseInt(el.len.value,10); lockLen(true); regStart=Date.now(); stpStart=0; pausedAt=0; earlyOffset=0; setState(S.H1_REG); }
  function startH2(){ regStart=Date.now(); stpStart=0; pausedAt=0; earlyOffset=0; setState(S.H2_REG); }

  function halftime(){
    if(state===S.H1_STP){ // Positiivinen lisäaika
      h1Stoppage = Math.floor((Date.now()-stpStart)/1000);
      h1RegDisp = perHalf;
    } else if(state===S.H1_EARLY){ // Keskeytys
      h1Stoppage = -Math.floor(earlyOffset);
      h1RegDisp = Math.floor(pausedAt);
    }
    setState(S.HT);
  }
  function fulltime(){
    if(state===S.H2_STP){
      h2Stoppage = Math.floor((Date.now()-stpStart)/1000);
      h2RegDisp = perHalf;
    } else if(state===S.H2_EARLY){
      h2Stoppage = -Math.floor(earlyOffset);
      h2RegDisp = Math.floor(pausedAt);
    }
    setState(S.FT);
  }
  function resetAll(){
    setState(S.PRE); lockLen(false);
    regStart = stpStart = 0; pausedAt = earlyOffset = 0;
    h1Stoppage = h2Stoppage = 0; h1RegDisp = h2RegDisp = 0;
    el.summary.innerHTML='';
  }

  function stopEarly(){
    const elapsed = (Date.now()-regStart)/1000; // s
    pausedAt = Math.max(0, Math.floor(elapsed));
    earlyOffset = Math.max(0, Math.floor(perHalf - elapsed));
    if(state===S.H1_REG) setState(S.H1_EARLY);
    if(state===S.H2_REG) setState(S.H2_EARLY);
    playBeep();
  }
  function resumePlay(){
    // jatka täsmälleen siitä mihin jäätiin
    regStart = Date.now() - pausedAt*1000;
    earlyOffset = 0; pausedAt = 0;
    el.stoppageClock.classList.add('hidden');
    el.stoppageClock.classList.remove('negative','positive');
    if(state===S.H1_EARLY) setState(S.H1_REG);
    if(state===S.H2_EARLY) setState(S.H2_REG);
  }

  function tick(){
    const now=Date.now();
    if(state===S.H1_REG || state===S.H2_REG){
      const elapsed=(now-regStart)/1000;
      if(elapsed>=perHalf){
        el.regClock.textContent=fmtMS(perHalf);
        if(!stpStart){ stpStart=now; playBeep(); }
        setState(state===S.H1_REG?S.H1_STP:S.H2_STP);
      } else {
        el.regClock.textContent=fmtMS(elapsed);
      }
      el.stoppageClock.classList.add('hidden');
      el.stoppageClock.classList.remove('positive','negative');
    }
    else if(state===S.H1_STP || state===S.H2_STP){
      el.regClock.textContent=fmtMS(perHalf);
      const stp=(now-stpStart)/1000;
      el.stoppageClock.textContent=fmtPlus(stp);
      el.stoppageClock.classList.remove('hidden');
      el.stoppageClock.classList.add('positive');
      el.stoppageClock.classList.remove('negative');
    }
    else if(state===S.H1_EARLY || state===S.H2_EARLY){
      // Pysäytetty: kello ei juokse, näytetään keskeytyshetken aika ja negatiivinen offset
      el.regClock.textContent = fmtMS(pausedAt);
      el.stoppageClock.textContent = fmtSigned(-earlyOffset); // punainen miinus
      el.stoppageClock.classList.remove('hidden');
      el.stoppageClock.classList.add('negative');
      el.stoppageClock.classList.remove('positive');
    }
    requestAnimationFrame(tick);
  }

  function summaryRow(lbl, regSec, stpSec, totalSec){
    const stpClass = stpSec>=0 ? 'pos' : 'neg';
    const stpText = fmtSigned(stpSec);
    return `<div class="sumRow"><span class="lbl">${lbl}</span><span class="val">${fmtMS(regSec)} <span class="stp ${stpClass}">${stpText}</span> = ${fmtMS(totalSec)}</span></div>`;
  }

  function updateUI(){
    // piilota kaikki
    el.btnStart.classList.add('hidden');
    el.btnHalftime.classList.add('hidden');
    el.btnStartH2.classList.add('hidden');
    el.btnEnd.classList.add('hidden');
    el.btnReset.classList.add('hidden');
    el.btnStopEarly.classList.add('hidden');
    el.btnResume.classList.add('hidden');

    switch(state){
      case S.PRE:
        el.phase.textContent='Valmis – Ennen ottelua';
        el.statusBadge.textContent='⏳ Odottaa käynnistystä';
        el.btnStart.classList.remove('hidden');
        el.regClock.textContent='00:00'; el.stoppageClock.classList.add('hidden'); el.h1Badge.classList.add('hidden');
        break;

      case S.H1_REG:
        el.phase.textContent='1. puoliaika – Peliaika';
        el.statusBadge.textContent='▶︎ 1. puoliaika käynnissä';
        el.btnStopEarly.classList.remove('hidden');
        break;

      case S.H1_STP:
        el.phase.textContent='1. puoliaika – Lisäaika';
        el.statusBadge.textContent='⏱️ Lisäaika käynnissä (1. jakso)';
        el.btnHalftime.classList.remove('hidden');
        break;

      case S.H1_EARLY:
        el.phase.textContent='1. puoliaika – Keskeytetty';
        el.statusBadge.textContent='⛔ Keskeytetty ennen täyttä aikaa';
        el.btnResume.classList.remove('hidden');
        el.btnHalftime.classList.remove('hidden');
        break;

      case S.HT:
        el.phase.textContent='Erätauko'; el.statusBadge.textContent='⏸️ Erätauko';
        el.btnStartH2.classList.remove('hidden');
        // Yhteenveto H1
        const h1Total = (h1Stoppage>=0) ? (perHalf + h1Stoppage) : h1RegDisp;
        el.summary.innerHTML = summaryRow('1. puoliaika', (h1RegDisp||perHalf), h1Stoppage, h1Total);
        el.h1Badge.textContent = `1. puoliaika: ${fmtMS(h1RegDisp||perHalf)} ${fmtSigned(h1Stoppage)} = ${fmtMS(h1Total)}`;
        el.h1Badge.classList.remove('hidden');
        break;

      case S.H2_REG:
        el.phase.textContent='2. puoliaika – Peliaika'; el.statusBadge.textContent='▶︎ 2. puoliaika käynnissä'; el.btnStopEarly.classList.remove('hidden');
        break;

      case S.H2_STP:
        el.phase.textContent='2. puoliaika – Lisäaika'; el.statusBadge.textContent='⏱️ Lisäaika käynnissä (2. jakso)'; el.btnEnd.classList.remove('hidden');
        break;

      case S.H2_EARLY:
        el.phase.textContent='2. puoliaika – Keskeytetty'; el.statusBadge.textContent='⛔ Keskeytetty ennen täyttä aikaa';
        el.btnResume.classList.remove('hidden'); el.btnEnd.classList.remove('hidden');
        break;

      case S.FT:
        el.phase.textContent='Päättynyt';
        el.statusBadge.textContent='✔️ Ottelu päättynyt';
        el.btnReset.classList.remove('hidden');
        // Yhteenveto molemmat jaksot (värit +/− stp:n mukaan)
        const h1TotalFT = h1Stoppage>=0 ? (perHalf + h1Stoppage) : h1RegDisp;
        const h2TotalFT = h2Stoppage>=0 ? (perHalf + h2Stoppage) : h2RegDisp;
        const h1Row = summaryRow('1. puoliaika', (h1RegDisp||perHalf), h1Stoppage, h1TotalFT);
        const h2Row = summaryRow('2. puoliaika', (h2RegDisp||perHalf), h2Stoppage, h2TotalFT);
        const total = fmtMS((h1TotalFT||0) + (h2TotalFT||0));
        el.summary.innerHTML = h1Row + h2Row + `<div class="sumRow"><span class="lbl">Kokonaisaika</span><span class="val">${total}</span></div>`;
        break;
    }
  }

  // Handlers
  el.btnStart.addEventListener('click', startH1);
  el.btnStartH2.addEventListener('click', startH2);
  el.btnHalftime.addEventListener('click', ()=>{ if(state===S.H1_STP || state===S.H1_EARLY) halftime(); });
  el.btnEnd.addEventListener('click', ()=>{ if(state===S.H2_STP || state===S.H2_EARLY) fulltime(); });
  el.btnReset.addEventListener('click', resetAll);
  el.btnStopEarly.addEventListener('click', stopEarly);
  el.btnResume.addEventListener('click', resumePlay);

  el.len.addEventListener('change', ()=>{ if(state===S.PRE){ perHalf=parseInt(el.len.value,10); el.regClock.textContent='00:00'; el.stoppageClock.classList.add('hidden'); }});

  requestAnimationFrame(function raf(){ tick(); });
  updateUI();
})();
</script>
</body>
</html>
